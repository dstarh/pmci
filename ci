#!/bin/bash
BRANCH=$@
if [ "" == "$BRANCH" ]; then
  echo PLEASE SPECIFY A BRANCH NAME
  exit
fi
git checkout -t origin/$BRANCH
git checkout $BRANCH
while [ 1 ]; do
  git fetch origin
  git ls-remote . | grep "heads/$BRANCH$" | awk '{print $1}' > /tmp/$BRANCH-heads.hash
  git ls-remote . | grep "origin/$BRANCH$" | awk '{print $1}' > /tmp/$BRANCH-origin.hash
  DIFF=`diff /tmp/$BRANCH-heads.hash /tmp/$BRANCH-origin.hash`
  if [ "" != "$DIFF" ]; then
    git pull origin $BRANCH > $BRANCH.log
    rake parallel:migrate
    time rake parallel:test >> $BRANCH.log
    ERR=`grep Failure $BRANCH.log`
    if [ "" != "$ERR" ]; then
      cat $BRANCH.log | mail -s "Build Failure" pmci@rudiment.net
    fi
  else
    echo NO CHANGES YET
  fi
  sleep 60s
done
